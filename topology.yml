tosca_definitions_version: alien_dsl_1_4_0

metadata:
  template_name: Wordpress
  template_version: 0.1.0-SNAPSHOT
  template_author: admin

description: ""

imports:
  - wordpress-type:1.4.0-SNAPSHOT
  - tosca-normative-types:1.0.0-ALIEN14
  - php-type:1.4.0-SNAPSHOT
  - mysql-type:1.4.0-SNAPSHOT
  - apache-type:1.4.0-SNAPSHOT

topology_template:
  inputs:
    os_distribution:
      type: string
      required: true
      default: ubuntu
      constraints:
        - valid_values: [debian, ubuntu, knoppix]
      description: "The host Operating System (OS) architecture."
  node_templates:
    wordpress:
      type: org.alien4cloud.nodes.Wordpress
      properties:
        zip_url: "https://wordpress.org/latest.zip"
        context_root: "/"
      requirements:
        - php:
            node: php
            capability: org.alien4cloud.capabilities.PHPModule
            relationship: org.alien4cloud.relationships.WordpressConnectToPHP
      capabilities:
        app_endpoint:
          properties:
            protocol: tcp
            secure: false
            network_name: PRIVATE
            initiator: source
    php:
      type: org.alien4cloud.nodes.PHP
      properties:
        component_version: 5
  outputs:
    wordpress_wordpress_url:
      value: { get_attribute: [ wordpress, wordpress_url ] }
  workflows:
    install:
      steps:
        start_php:
          node: php
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - php_started
        php_starting:
          node: php
          activity:
            set_state: starting
          on-success:
            - start_php
        wordpress_creating:
          node: wordpress
          activity:
            set_state: creating
          on-success:
            - create_wordpress
        php_creating:
          node: php
          activity:
            set_state: creating
          on-success:
            - create_php
        php_configuring:
          node: php
          activity:
            set_state: configuring
          on-success:
            - configure_php
        create_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - wordpress_created
        configure_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - wordpress_configured
        php_created:
          node: php
          activity:
            set_state: created
          on-success:
            - php_configuring
        create_php:
          node: php
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - php_created
        wordpress_started:
          node: wordpress
          activity:
            set_state: started
        wordpress_initial:
          node: wordpress
          activity:
            set_state: initial
          on-success:
            - wordpress_creating
        wordpress_configured:
          node: wordpress
          activity:
            set_state: configured
          on-success:
            - wordpress_starting
        php_configured:
          node: php
          activity:
            set_state: configured
          on-success:
            - php_starting
        wordpress_created:
          node: wordpress
          activity:
            set_state: created
          on-success:
            - php_configuring
            - wordpress_configuring
        wordpress_starting:
          node: wordpress
          activity:
            set_state: starting
          on-success:
            - start_wordpress
        start_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - wordpress_started
        php_started:
          node: php
          activity:
            set_state: started
          on-success:
            - wordpress_configuring
        php_initial:
          node: php
          activity:
            set_state: initial
          on-success:
            - php_creating
        configure_php:
          node: php
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - php_configured
        wordpress_configuring:
          node: wordpress
          activity:
            set_state: configuring
          on-success:
            - configure_wordpress
    uninstall:
      steps:
        stop_php:
          node: php
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - php_stopped
        wordpress_stopping:
          node: wordpress
          activity:
            set_state: stopping
          on-success:
            - stop_wordpress
        php_deleting:
          node: php
          activity:
            set_state: deleting
          on-success:
            - delete_php
        php_stopped:
          node: php
          activity:
            set_state: stopped
          on-success:
            - php_deleting
        delete_php:
          node: php
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.delete
          on-success:
            - php_deleted
        php_deleted:
          node: php
          activity:
            set_state: deleted
        delete_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.delete
          on-success:
            - wordpress_deleted
        stop_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - wordpress_stopped
        php_stopping:
          node: php
          activity:
            set_state: stopping
          on-success:
            - stop_php
        wordpress_stopped:
          node: wordpress
          activity:
            set_state: stopped
          on-success:
            - php_stopping
            - wordpress_deleting
        wordpress_deleting:
          node: wordpress
          activity:
            set_state: deleting
          on-success:
            - delete_wordpress
        wordpress_deleted:
          node: wordpress
          activity:
            set_state: deleted
    start:
      steps:
        start_php:
          node: php
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - php_started
        php_starting:
          node: php
          activity:
            set_state: starting
          on-success:
            - start_php
        wordpress_starting:
          node: wordpress
          activity:
            set_state: starting
          on-success:
            - start_wordpress
        start_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - wordpress_started
        php_started:
          node: php
          activity:
            set_state: started
          on-success:
            - wordpress_starting
        wordpress_started:
          node: wordpress
          activity:
            set_state: started
    stop:
      steps:
        stop_php:
          node: php
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - php_stopped
        wordpress_stopping:
          node: wordpress
          activity:
            set_state: stopping
          on-success:
            - stop_wordpress
        stop_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - wordpress_stopped
        php_stopping:
          node: php
          activity:
            set_state: stopping
          on-success:
            - stop_php
        php_stopped:
          node: php
          activity:
            set_state: stopped
        wordpress_stopped:
          node: wordpress
          activity:
            set_state: stopped
