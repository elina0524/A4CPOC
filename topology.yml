tosca_definitions_version: alien_dsl_1_4_0

metadata:
  template_name: Wordpress
  template_version: 0.1.0-SNAPSHOT
  template_author: admin

description: ""

imports:
  - wordpress-type:1.4.0-SNAPSHOT
  - tosca-normative-types:1.0.0-ALIEN14
  - php-type:1.4.0-SNAPSHOT
  - mysql-type:1.4.0-SNAPSHOT
  - apache-type:1.4.0-SNAPSHOT

topology_template:
  inputs:
    os_distribution:
      type: string
      required: true
      default: ubuntu
      constraints:
        - valid_values: [debian, ubuntu, knoppix]
      description: "The host Operating System (OS) architecture."
  node_templates:
    wordpress:
      type: org.alien4cloud.nodes.Wordpress
      properties:
        zip_url: "https://wordpress.org/latest.zip"
        context_root: "/"
      requirements:
        - host:
            node: apache
            capability: org.alien4cloud.capabilities.ApacheContainer
            relationship: org.alien4cloud.relationships.WordpressHostedOnApache
      capabilities:
        app_endpoint:
          properties:
            protocol: tcp
            secure: false
            network_name: PRIVATE
            initiator: source
    apache:
      type: org.alien4cloud.nodes.Apache
      properties:
        component_version: 2.4
        port: 80
        document_root: "/var/www"
      requirements:
        - dependency:
            node: PHP
            capability: tosca.capabilities.Node
            relationship: tosca.relationships.DependsOn
      capabilities:
        data_endpoint:
          properties:
            protocol: tcp
            secure: false
            network_name: PRIVATE
            initiator: source
        admin_endpoint:
          properties:
            secure: true
            protocol: tcp
            network_name: PRIVATE
            initiator: source
    PHP:
      type: org.alien4cloud.nodes.PHP
      properties:
        component_version: 5
  outputs:
    wordpress_wordpress_url:
      value: { get_attribute: [ wordpress, wordpress_url ] }
  workflows:
    install:
      steps:
        wordpress_creating:
          node: wordpress
          activity:
            set_state: creating
          on-success:
            - create_wordpress
        apache_creating:
          node: apache
          activity:
            set_state: creating
          on-success:
            - create_apache
        create_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - wordpress_created
        create_apache:
          node: apache
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - apache_created
        configure_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - wordpress_configured
        wordpress_started:
          node: wordpress
          activity:
            set_state: started
        apache_starting:
          node: apache
          activity:
            set_state: starting
          on-success:
            - start_apache
        start_apache:
          node: apache
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - apache_started
        configure_apache:
          node: apache
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - apache_configured
        wordpress_initial:
          node: wordpress
          activity:
            set_state: initial
          on-success:
            - wordpress_creating
        wordpress_configured:
          node: wordpress
          activity:
            set_state: configured
          on-success:
            - wordpress_starting
        apache_configuring:
          node: apache
          activity:
            set_state: configuring
          on-success:
            - configure_apache
        apache_created:
          node: apache
          activity:
            set_state: created
          on-success:
            - PHP_configuring
            - apache_configuring
        apache_configured:
          node: apache
          activity:
            set_state: configured
          on-success:
            - apache_starting
        apache_initial:
          node: apache
          activity:
            set_state: initial
          on-success:
            - apache_creating
        wordpress_created:
          node: wordpress
          activity:
            set_state: created
          on-success:
            - wordpress_configuring
        wordpress_starting:
          node: wordpress
          activity:
            set_state: starting
          on-success:
            - start_wordpress
        start_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - wordpress_started
        apache_started:
          node: apache
          activity:
            set_state: started
          on-success:
            - wordpress_initial
        wordpress_configuring:
          node: wordpress
          activity:
            set_state: configuring
          on-success:
            - configure_wordpress
        PHP_initial:
          node: PHP
          activity:
            set_state: initial
          on-success:
            - PHP_creating
        PHP_creating:
          node: PHP
          activity:
            set_state: creating
          on-success:
            - create_PHP
        create_PHP:
          node: PHP
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - PHP_created
        PHP_created:
          node: PHP
          activity:
            set_state: created
          on-success:
            - PHP_configuring
        PHP_configuring:
          node: PHP
          activity:
            set_state: configuring
          on-success:
            - configure_PHP
        configure_PHP:
          node: PHP
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - PHP_configured
        PHP_configured:
          node: PHP
          activity:
            set_state: configured
          on-success:
            - PHP_starting
        PHP_starting:
          node: PHP
          activity:
            set_state: starting
          on-success:
            - start_PHP
        start_PHP:
          node: PHP
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - PHP_started
        PHP_started:
          node: PHP
          activity:
            set_state: started
          on-success:
            - apache_configuring
    uninstall:
      steps:
        wordpress_stopping:
          node: wordpress
          activity:
            set_state: stopping
          on-success:
            - stop_wordpress
        delete_apache:
          node: apache
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.delete
          on-success:
            - apache_deleted
        apache_deleted:
          node: apache
          activity:
            set_state: deleted
        apache_stopping:
          node: apache
          activity:
            set_state: stopping
          on-success:
            - stop_apache
        apache_deleting:
          node: apache
          activity:
            set_state: deleting
          on-success:
            - delete_apache
        delete_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.delete
          on-success:
            - wordpress_deleted
        stop_apache:
          node: apache
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - apache_stopped
        apache_stopped:
          node: apache
          activity:
            set_state: stopped
          on-success:
            - PHP_stopping
            - apache_deleting
        stop_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - wordpress_stopped
        wordpress_stopped:
          node: wordpress
          activity:
            set_state: stopped
          on-success:
            - wordpress_deleting
        wordpress_deleting:
          node: wordpress
          activity:
            set_state: deleting
          on-success:
            - delete_wordpress
        wordpress_deleted:
          node: wordpress
          activity:
            set_state: deleted
          on-success:
            - apache_stopping
        PHP_stopping:
          node: PHP
          activity:
            set_state: stopping
          on-success:
            - stop_PHP
        stop_PHP:
          node: PHP
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - PHP_stopped
        PHP_stopped:
          node: PHP
          activity:
            set_state: stopped
          on-success:
            - PHP_deleting
        PHP_deleting:
          node: PHP
          activity:
            set_state: deleting
          on-success:
            - delete_PHP
        delete_PHP:
          node: PHP
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.delete
          on-success:
            - PHP_deleted
        PHP_deleted:
          node: PHP
          activity:
            set_state: deleted
    start:
      steps:
        wordpress_starting:
          node: wordpress
          activity:
            set_state: starting
          on-success:
            - start_wordpress
        start_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - wordpress_started
        wordpress_started:
          node: wordpress
          activity:
            set_state: started
        apache_starting:
          node: apache
          activity:
            set_state: starting
          on-success:
            - start_apache
        start_apache:
          node: apache
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - apache_started
        apache_started:
          node: apache
          activity:
            set_state: started
          on-success:
            - wordpress_starting
        PHP_starting:
          node: PHP
          activity:
            set_state: starting
          on-success:
            - start_PHP
        start_PHP:
          node: PHP
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - PHP_started
        PHP_started:
          node: PHP
          activity:
            set_state: started
          on-success:
            - apache_starting
    stop:
      steps:
        wordpress_stopping:
          node: wordpress
          activity:
            set_state: stopping
          on-success:
            - stop_wordpress
        stop_apache:
          node: apache
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - apache_stopped
        apache_stopping:
          node: apache
          activity:
            set_state: stopping
          on-success:
            - stop_apache
        apache_stopped:
          node: apache
          activity:
            set_state: stopped
        stop_wordpress:
          node: wordpress
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - wordpress_stopped
        wordpress_stopped:
          node: wordpress
          activity:
            set_state: stopped
          on-success:
            - apache_stopping
        PHP_stopping:
          node: PHP
          activity:
            set_state: stopping
          on-success:
            - stop_PHP
        stop_PHP:
          node: PHP
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - PHP_stopped
        PHP_stopped:
          node: PHP
          activity:
            set_state: stopped
